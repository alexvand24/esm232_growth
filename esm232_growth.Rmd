---
title: "Forest Growth Model"
author: "Kristin Gill, Quin Smith, Alex Vand"
date: "5/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(sensitivity)
library(deSolve)
```

Forest growth model components:

- C = size of the forest (units of carbon)
- K = carrying capacity (unit of carbon)
- r = early exponential growth rate
- g = linear growth rate once canopy closure has been reached
- dC/dt = rate of change of forest size
- canopy closure threshold = size of the forest at which growth rates change from exponential to linear (from r to g)


```{r}
# early exponential growth rate
# dC_dt <- r * C for forests where C is below a threshold canopy closure

# exp_growth <- function(r = 0.01, C){
#   dC_dt <- r * C
#   return(dC_dt)
# }
```

```{r}
# linear growth rate once canopy closure has been reached
# for forests where carbon is at or above the threshold canopy closure

# linear_growth <- function(r = 0.01, g = 2){
#   dC_dt <- g * (1 - C/K)
#   return(dC_dt)
# }
```



# from Naomi github [pop_growth_with_K_and_sobol.Rmd](https://github.com/naomitague/ESM232_Examples/blob/main/Rmarkdown/pop_growth_with_K_and_sobol.Rmd)

```{r, error=TRUE}
source(here("dexppopK.R"))
dexppopK
# want to learn about sensitivity to growth rate (r) and carrying capacity 
# set the number of parameters
np=100
K = rnorm(mean=300, sd=50, n=np)
r = rnorm(mean=0.01, sd=0.005, n=np)
X1 = cbind.data.frame(r=r, K=K)
# repeat to get our second set of samples
K = rnorm(mean=300, sd=50, n=np)
r = rnorm(mean=0.01, sd=0.005, n=np)
X2 = cbind.data.frame(r=r, K=K)
sens_P = sobolSalt(model = NULL,X1, X2, nboot = 300)
# our parameter sets are
head(sens_P$X)
# lets add names 
colnames(sens_P$X) = c("r","K")
# I may re-use this function so I saved it as a file 
# maxyear doesn't make sense for a growth that slows gradually - so I'll use year when population doubles


# CODE BREAKS HERE. don't yet have the following R script in the repo


source("../R/compute_pop_metrics.R")
Pinitial = 100
# I continually update the wrapper to I'll keep in inline
# you could make it a separate file as well 
simtimes=seq(from=1, to=500, by=5)
p_wrapper = function(r,K, Pinitial, simtimes, func, metrics_func) {
    parms = list(r=r, K=K)
    result = ode(y=Pinitial, times=simtimes, func=func, parms=parms) 
    colnames(result)=c("time","P")
  # get metrics
    metrics=as.data.frame(result) %>% metrics_func()
  return(metrics)
}
allresults = as.data.frame(sens_P$X) %>% pmap(p_wrapper, Pinitial=Pinitial, simtimes=simtimes, func=dexppopK, metrics_func=compute_pop_metrics)
# extract out results from pmap into a data frame
allres = allresults %>% map_dfr(`[`,c("maxpop","dyear"))
# create boxplots
tmp = allres %>% gather(key="metric", value="value")
ggplot(tmp, aes(metric, value, col=metric))+geom_boxplot()
# compute sobol indicies (separately for the two different outputs)
sens_P_maxpop = sensitivity::tell(sens_P,allres$maxpop)
# first-order indices (main effect without co-variance)
sens_P_maxpop$S
# total sensitivity index -note that this partitions the output variance - so values sum to 1
sens_P_maxpop$T
# create another one for max year
sens_P_dyear = sensitivity::tell(sens_P,allres$dyear)
# first-order indices (main effect without co-variance)
#notice that this fails because of NAs - scenarios where population does not double
summary(allres$dyear)
# clean up option - not ideal but will work - set double year to max simtimes
allres$dyear_clean = ifelse(is.na(allres$dyear), max(simtimes), allres$dyear)
sens_P_dyear = sensitivity::tell(sens_P,allres$dyear_clean)
sens_P_dyear$S
# total sensitivity index -note that this partitions the output variance - so values sum to 1
sens_P_dyear$T
```


# *Instructions*

Implement this model in R (as a differential equation) (Grading 25% - we will look for correct implementation but also good programming style - meaningful variable names, comments/documentation throughout)

Run the model for 300 years (using the ODE solver) starting with an initial forest size of 10 kg/C, and using the following parameters

canopy closure threshold of 50 kgC

K = 250 kg C (carrying capacity)

r= 0.01 (exponential growth rate before before canopy closure)

g = 2 kg/year (linear growth rate after canopy closure)

Graph the results. (15% - we look for an appropriate graphs and good visualization practice - labels, etc)

Run a sobol sensitivity analysis that explores how the estimated maximum and mean forest size (e.g maximum and mean values of C over the 300 years) varies with the pre canopy closure growth rate (r) and post-canopy closure growth rate (g) and canopy closure threshold and carrying capacity(K)
Assume that parameters are all normally distributed with means as given above and standard deviation of 10% of mean value

Graph the results of the sensitivity analysis as a box plot of maximum forest size and a plot of the two Sobol indices (S and T). (25% - correct implementation of Sobol and good graphing style -label etc )

In 2-3 sentences, discuss what the results of your simulation might mean for climate change impacts on forest growth (e.g think about what parameters climate change might influence ). (25% - wee look for reasonable discussion that uses the results from your analysis and give extra points for discussions that offer particularly creative or insightful commentary)

Submit R markdown with model implementation, graphs and sensitivity analysis and R file with your model

(Final 10% for well organized clear R markdown)


