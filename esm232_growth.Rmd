---
title: "Forest Growth Model"
author: "Kristin Gill, Quin Smith, Alex Vand"
date: "5/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(sensitivity)
library(deSolve)
library(purrr)
```

```{r}
# set parameters
K = 250
r = 0.01
g = 2
cc_threshold = 50

forestparms <- list(r = r, g = g, K = K, C, cc_threshold = cc_threshold)

# create a time sequence
times = seq(from = 1, to = 300)

# start a small forest
C_initial = 10

source(here("R", "growth.R"))

# watch it grow
forest = ode(y = C_initial, times = times, growth, parms=forestparms)

colnames(forest)=c("Time","Carbon")

ggplot(as.data.frame(forest),aes(x = Time, y = Carbon) ) +
  geom_line() +
  theme_minimal()
```


## Sobol Sensitivity Analysis
```{r, error=TRUE}
# we want to learn about sensitivity to growth rates (r,g), carrying capacity (K), and the canopy closure threshold (cc_threshold)

# set the number of parameters
np=100
K = rnorm(mean = K, sd = K*0.1, n=np)
r = rnorm(mean = r, sd = r*0.1, n=np)
g = rnorm(mean = g, sd = g*0.1, n=np)
cc_threshold = rnorm(mean = cc_threshold, sd = cc_threshold*0.1, n=np)

X1 = cbind.data.frame(r=r, K=K, g=g, cc_threshold=cc_threshold)

# repeat to get our second set of samples
np=100
K = rnorm(mean = K, sd = K*0.1, n=np)
r = rnorm(mean = r, sd = r*0.1, n=np)
g = rnorm(mean = g, sd = g*0.1, n=np)
cc_threshold = rnorm(mean = cc_threshold, sd = cc_threshold*0.1, n=np)

X2 = cbind.data.frame(r=r, K=K, g=g, cc_threshold=cc_threshold)

# create sobol object and get parameters
sens_forest = sobolSalt(model = NULL,X1, X2, nboot = 300)

colnames(sens_forest$X) = c("r","K", "g", "cc_threshold")

#parameters = list(r=sens_forest$X[1,1], K=sens_forest$X[1,2], g=sens_forest$X[1,3], cc_threshold=sens_forest$X[1,4])

#forest_sensitivity = ode(y = C_initial, times = times, growth, parms=parameters)
```


```{r}
# pull out max and mean values of c
compute_metrics <- function(x) {
  max_val <- max(x)
  mean_val <- mean(x)
  return(list(max_val=max_val, mean_val=mean_val))
}

# use wrapper function to return the forest size values
growth_wrapper <- function(r, K, g, cc_threshold, C_initial, times, func) {
  parms <- list(r=r, K=K, g=g, cc_threshold=cc_threshold)
  result <- ode(y=C_initial, times=times, func=func, parms=parms)
  result <- as.data.frame(result)
  colnames(result) = c("Time", "C")
  #get metrics
  metrics <- compute_metrics(result$C)
  return(metrics)
}

allresults <- as.data.frame(sens_forest$X) %>% pmap(growth_wrapper, C_initial = C_initial, times = times, func = growth)

allres <- allresults %>% 
  map_dfr(`[`, c("max_val", "mean_val")) %>% 
  rename(Maximum_Value = max_val, Mean_Value = mean_val)

# calculate the Sobol indicies
sens_forest_maxval <- sensitivity::tell(sens_forest, allres$Maximum_Value)

# Indices (main effect without co-variance)
tmpS <- sens_forest_maxval$S
rownames(tmpS) = c("r","K", "g", "cc_threshold")

tmpS <- tmpS %>% 
  rownames_to_column(var = "Parameter")

# Indices (total effect with co-variance)
tmpT <- sens_forest_maxval$T
rownames(tmpT) = c("r","K", "g", "cc_threshold")

tmpT <- tmpT %>% 
  rownames_to_column(var = "Parameter")

# create indices barplots
plotT <- ggplot(data = tmpT, aes(x = original, y = Parameter)) + geom_col()
plotS <- ggplot(data = tmpS, aes(x = original, y = Parameter)) + geom_col()

# create a box plot
tmp <- allres %>% 
  pivot_longer(cols = c(Maximum_Value, Mean_Value), names_to = "Metric", values_to = "Value")

max_df <- tmp %>% 
  filter(Metric == "Maximum_Value")

ggplot(data = tmp, aes(x = Metric, y = Value)) +
  geom_boxplot() +
  facet_wrap(~Metric, scales = "free") +
  theme_minimal()
```

```{r}
# try to fix scaling... MEAN PLOT IS REALLY WEIRD
max_df <- tmp %>% 
  filter(Metric == "max_val")

mean_df <- tmp %>% 
  filter(Metric == "mean_val")

max_plot <- ggplot(max_df, aes(x = Metric, y = Value)) +
  geom_boxplot()

mean_plot <- ggplot(mean_df, aes(x = Metric, Y = Value)) +
  geom_boxplot()

max_plot
mean_plot
```

